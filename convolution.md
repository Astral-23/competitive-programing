
# convotuion
$$ c_k = \sum_{0 \le i \le k} A[i]B[k-i]$$
について、 $c_0, c_1, ... , c_{|A| + |B| - 1}$ を列挙する。


> 命題(関数の値の畳み込み): $$ c_k = \sum_{0 \le i \le k} f(i)g(k-i)$$
> は、各引数での関数の値を計算し配列に記録することで同様に計算できる
- 素直に配列の形でなくても、一変数関数で上記を満たせば計算できる。

> 命題(添字): 畳み込みの式について、添字はこの通りである必要はなく、$c_k$は添字の和が $k$(定数)であるペア全てについての和を意味する。  
例えば $\sum_{i=0}^{|A| - 1} A[|A| - i - 1]B[i  + k]$ は $c_{|A| + k-1}$と一致する。

> 命題(reverse畳み込み)
> $\bar{B}$ を $B$ のreverseとする。この時、
> $$ c_k = \sum_{0 \le i \le k} A[i]\bar{B}[k-i]$$
> $$ = \sum_{0 \le i \le k} A[i]B[|B| - k + i - 1]$$
> $$ \sum_{j - i = |B| - k - 1} A[i]B[j]$$
> であり、つまり差を固定した時の積のと一致する


このように、
- |A||B|のループで
- 各要素について、2項を演算でまとめたものの和

を高速に求めたい時、convolutionの帰着が出来やすい。

- |A||A| の時もある。定数が綺麗な|sz| * |sz|のループで求まることが大切。(|sz| * |sz| / 2とかでも良い: (i < j))
    - Ai + Aj = k となる(i, j)のペアは何通り？

# 求まるもの
大雑把: 加算されるデータと乗算されるデータのペア。場合によっては掛けた関数の数もデータ。
- 加算は次数...個数、総和
- 乗算は係数...場合の数
- 掛けた関数の数...「3つ選んで、総和Xになるような場合の和」など

- X個選ぶ時の....
    - X個が指数、係数が情報
    - 例: https://atcoder.jp/contests/abc352/tasks/abc352_g
    

- 選んだ個数事のテーブル
    - A1, A2... , Anに対して、選んだ個数ごとに $\sum \prod A_{選んだ}$ を求めよ[link](https://atcoder.jp/contests/arc140/editorial/3966)
    
    
- (和、場合の数)-> 和を次数(添字)に持ってくれば良い
    - 分布をconvolutionすることになる
        - [Ai + Aj + Ak = X](https://atcoder.jp/contests/arc185/tasks/arc185_c)
- [gcd_convolve: $\sum_{gcd(A_i, A_j) = k} A_iA_j$](https://atcoder.jp/contests/agc038/tasks/agc038_c)
    - $\sum_{gcd(i, j) = k}$ の形になって欲しい
    - これもまた分布列を持てば良い
        - $\sum$ のループを添字ではなく値にするイメージ
        - $\sum_{gcd(i, j) = k} (i\times cnt_i) \times (j\times cnt_j)$

# データの解釈

- 2要素convolution
$$c_k = \sum_{i ・ j = k} a[i] \oplus b[j]$$
全ての2要素のペアについて、その添字を演算結果それぞれについて（テーブル）、値の演算結果の合計を求めている
    - ・がgcdだったり、lcmだったり...
        - 「i, jが互いに素・ではない 2ペア全てについてOOのsumを求めよ」を扱える

- 3要素convolution
    - $a + b + c = (a + b) + c$ のように、3項演算が2項演算でかけるならば
    - 「全ての3要素のペアについて、その添字を演算結果それぞれについて（テーブル）、値の演算結果の合計を求めている
:::spoiler fpsのモチベ
## fpsのモチベ
- fpsじゃ無いと厳しい問題がある
    
    - 要素ごとに $K$ 個の選択肢がある部分和問題
        - dp : $O(NMK)$  
        - fps : $O(NMlogM)$

    - 同じ要素しかない、 $K$ 個選択肢部分和問題
        -  fps : $O(KlogK$)
            - 　「同じ操作の繰り返し」が冪乗になる
                - 類題 ルーレットを回す、出目の和がmになる確率
            - 冪乗自体、高速に求まる
            - 冪乗の和が分数関数になって、やはり高速に求まる
            - 



    - 累積和が分数関数で表せることを使う
        - [例題](https://drken1215.hatenablog.com/entry/2020/10/25/051000)

## fpsで高速化される問題
### 愚直な探索では間に合わない。しかし、計算するテーブルのサイズは列挙に耐える場合
- https://atcoder.jp/contests/abc149/tasks/abc149_e
    - 探索では $O(N^2)$ だが、　$A_i + A_j$ の上限は$200'000$ である。
:::

::: spoiler fpsで解ける問題のイメージ
## fpsで解ける問題のイメージ
- 必要: テーブルのサイズが小さい
- 総和の制約があり、求めるものが「確率」や「組み合わせの数」等、　掛け算をするものである場合、母関数の積で表せる。
    - 定義 : 求める答えが x ^ n　の係数となる様な母関数

- 各試行ごとに、発生する影響が独立な場合

- 添字を1つだけ持つdpテーブル
    - 添字が合計の時、畳み込みが全探索に対応しやすい
        - a + b = n 
:::

:::spoiler fpsの前準備・定義とか
## 覚える事: 定義
$\mod x^n$ の定義とか
https://maspypy.com/%e5%a4%9a%e9%a0%85%e5%bc%8f%e3%83%bb%e5%bd%a2%e5%bc%8f%e7%9a%84%e3%81%b9%e3%81%8d%e7%b4%9a%e6%95%b0-%ef%bc%88%e8%a3%9c%e8%b6%b3%ef%bc%89%e5%ae%9a%e7%be%a9%e3%82%84%e5%bc%8f%e5%a4%89%e5%bd%a2
:::

## 部分和問題と分布のconvolution
分布関数 f[i] := iが何個あるか？ がある時、 $f \times f$ は何を表すか？ただし、各要素は添字付けられていて、区別するものとする。

f[i] := 総和がiになるような...なペアであることは確かだろう。ここで、1つの要素がconvolutionの左辺と右辺両方に登場していることに注意すると、以下がわかる。

$$ f[i] := 添字j, k (j \le k) のペアであって、A[j] + A[k] = iであるペア)\times 2 +  添字jであって、2A[j] = i を満たす j の個数$$

よってここから、「相異なる添字の2ペアであって、総和 = i になるペアの個数」が復元できる。

これは、テーブルのサイズが小さい時に使用できる

# fpsの諸定理


## 分数関数

$$\frac{1}{1 - f(x)} = 1 + f(x) + f(x)^2 ...$$

- 貰うdpとも見れる
- 特に、累積和: $\sum$ について、 $1-x$で割る事に対応する

### 扱い
### 総和
- fpsで表現した問題について、最終的な式にシグマが残っている場合、分数関数にすることで計算量が落ちる
- 分数関数自体の和 : 展開せずに、分数のまま扱った方が計算量が落ちる
    
<br><br>

# 立式からの高速化

- 項数の少ない式にする
    - 累積和
- x, yは纏める
    - 二項定理
https://maspypy.com/%e5%a4%9a%e9%a0%85%e5%bc%8f%e3%83%bb%e5%bd%a2%e5%bc%8f%e7%9a%84%e3%81%b9%e3%81%8d%e7%b4%9a%e6%95%b0%ef%bc%88%ef%bc%92%ef%bc%89%e5%bc%8f%e5%a4%89%e5%bd%a2%e3%81%ab%e3%82%88%e3%82%8b%e8%a7%a3%e6%b3%95

- 関数について纏める
    - 関数 $f_1, f_2, ... f_n$がある時、 (1) f_1が最小の項 (2) f_2が最小の項... と纏めてみる
        - dp的な結果の再利用が図れる
        


https://hackmd.io/@tatyam-prime/ryU4Ujup9
https://maspypy.com/%E5%A4%9A%E9%A0%85%E5%BC%8F%E3%83%BB%E5%BD%A2%E5%BC%8F%E7%9A%84%E3%81%B9%E3%81%8D%E7%B4%9A%E6%95%B0-%E9%AB%98%E9%80%9F%E3%81%AB%E8%A8%88%E7%AE%97%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%82%E3%81%AE#toc15
